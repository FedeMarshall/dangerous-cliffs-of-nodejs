<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>the dangerous cliffs of node.js</title><meta name="description" content="Some common but surprisingly impactful or difficult to deal with errors in Node.js"><meta name="author" content="Scott Nonnenberg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="stylesheet" href="css/reveal.min.css"><link rel="stylesheet" href="css/theme/default.css" id="theme"><link rel="stylesheet" href="css/zenburn.css"><script>document.write( "<link rel='stylesheet' href='css/" +
 ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + ".css' type='text/css' media='print'>" );
 </script><style>.center {
  display: inline-block;
  margin-left: auto;
  margin-right: auto;
}
.runner {
  position: relative;
}
a.run {
  position: absolute;
  bottom: .5em;
  right: 2em;
}
.reveal a.run:not(.image) {
  color: white;
}
.reveal .spacer {
  margin-top: 1em;
}
.reveal th, .reveal td {
  padding: .3em;
}
.reveal th {
  font-weight: bold;
}
.reveal img.plain {
  border: 0;
  box-shadow: none;
  background: none;
}
.reveal img.max {
  width: 95%;
}
.reveal .small {
  text-align: center;
  font-size: 60%;
}

</style></head><body><div class="reveal"><div class="slides"><section><h1>The Dangerious Cliffs of Node.js</h1><h3 class="spacer">Because production-ready is not easy!</h3><h3 class="spacer"><a target="_blank" href="https://scottnonnenberg.com">Scott Nonnenberg</a></h3><h4><a target="_blank" href="http://scottnonnenberg.github.io/dangerous-cliffs-of-nodejs/dist/slides.html">github.com/scottnonnenberg/dangerous-cliffs-of-nodejs</a></h4></section><section><section><h1>Why me?</h1><aside class="notes"><ul><li>History with other platforms like Rails, iOS, .NET, Java</li><li>Developing in node.js for over three years now</li><li>Own apps, and freelance...</li></ul></aside></section><section><h2>Walmart Labs</h2><h2>Nordstrom Innovation Lab</h2><h2>HaikuDeck</h2><h2>MuleSoft</h2></section></section><section><section><h1>Why am I here?</h1></section><section><h1>The gap</h1><aside class="notes"><ul><li>Lots of content tutorials/feature implementation</li><li>Much less about getting to production-ready</li></ul></aside></section><section><h1>How about a hike?</h1><aside class="notes"><ul><li>Node.js is like...</li><li>A friend says to you: Come on this hike with me!</li><li>My friends and I do it all the time!</li><li>So fun, so real-time, so fast, so productive!</li><li>And you say...</li></ul></aside></section><section><img src="img/doge.jpg"><aside class="notes"><ul><li>So fun, such real-time, many fast, wow productive!</li><li>Node.js! Doge.js??</li></ul></aside></section><section><img src="img/huashin trail.jpg" class="max"><aside class="notes"><ul><li>But then the trail is like this!</li><li>Your friend says "Oh yeah, we had some trouble the first couple times too..."</li><li>Before you hike this trail, it would have been good to know that it isn't like other trails</li><li>Node.js has some unique challenges.</li></ul></aside></section></section><section><img src="img/beware dangerous cliff.jpg" class="max"><aside class="notes"><ul><li>Let's put some signs up to help our fellow hikers!</li></ul></aside></section><section><section><h1>Crashes</h1><aside class="notes"><ul><li>What do we mean by this?</li><li>Calling a non-function or null</li><li>Dotting into a null/undefined var</li></ul></aside></section><section><h2>Crashes</h2><div class="center"><table><tr><td><span class="fragment">prevention</span></td><th><span class="fragment">hard</span></th></tr><tr><td><span class="fragment">impact</span></td><th><span class="fragment">high</span></th></tr><tr><td><span class="fragment">detection</span></td><th><span class="fragment">easy</span></th></tr><tr><td><span class="fragment">debuggability</span></td><th><span class="fragment">medium</span></th></tr></table></div><aside class="notes"><ul><li>prevention: <strong>hard</strong><ul><li>100% code coverage is no guarantee!</li><li>helps to check parameter types, fail fast</li></ul></li><li>impact: <strong>high</strong><ul><li>so easy to run into this, and the whole server goes down!</li><li>standard answer is just 'restart the server,' </li><li>but it's more impactful than you think, all other in-progress requests are interrupted!</li><li>(especially if you're coming from Rails, ASP, Java, etc.)</li></ul></li><li>detection: <strong>easy</strong><ul><li>standard error reporting: process.on('uncaughtException'), express error handler</li></ul></li><li>debuggability: <strong>medium</strong><ul><li>runtime gives you line/character number, callstack</li><li>but not how the data got that way...</li></ul></li></ul></aside></section><section><h1>Focus: Impact</h1><aside class="notes">can take it down to low/medium</aside></section><section><h1>Demo</h1></section></section><section><img src="img/cliff edges are dangerous.jpg" class="max"></section><section><section><h1>Hangs</h1></section><section><h2>Hangs</h2><div class="center"><table><tr class="fragment"><td>prevention</td><th>medium</th></tr><tr class="fragment"><td>impact</td><th>medium</th></tr><tr class="fragment"><td>detection</td><th>hard</th></tr><tr class="fragment"><td>debuggability</td><th>hard</th></tr></table></div><aside class="notes"><ul><li>prevention: <strong>medium</strong><ul><li>100% code coverage usually means no hangs</li><li>but it can happen in an external module too</li><li>story: redis in bad state, all authenticated user requests hanging</li></ul></li><li>impact: <strong>medium</strong><ul><li>client request never returns!</li><li>over time, will manifest as a memory leak as well</li></ul></li><li>detection: <strong>hard</strong><ul><li>hard to setup system to alert you, will be false positives</li></ul></li><li>debuggability: <strong>hard</strong><ul><li>just know the URL/route!</li></ul></li></ul></aside></section><section><h1>Focus: Detection</h1><aside class="notes">can take it down to medium/easy</aside></section><section><h1>Demo</h1></section><section><h2>hangs: downstream impact</h2><ul class="spacer"><li><strong>Chrome</strong> - error message after 2 minutes</li><li><strong>nginx</strong> - default timeout of 60 seconds</li><li><strong>Firefox</strong> - tbd</li><li><strong>Safari</strong> - tbd desktop, tbd mobile</li><li><strong>IE?</strong> - tbd</li></ul></section><section><h1>non-server apps</h1><aside class="notes"><ul><li>MUST have logging and/or stats collection</li><li>BOTH positive and negative metrics</li><li>if just errors, the process could be hanging or not running and you'd never know</li></ul></aside></section></section><section><img src="img/dangerous cliffs.jpg" class="max"></section><section><section><h1>Blocking event loop</h1></section><section><h2>Blocking event loop</h2><div class="center"><table><tr class="fragment"><td>prevention</td><th>medium</th></tr><tr class="fragment"><td>impact</td><th>high</th></tr><tr class="fragment"><td>detection</td><th>medium</th></tr><tr class="fragment"><td>debuggability</td><th>medium</th></tr></table></div><aside class="notes"><ul><li>prevention: <strong>medium</strong><ul><li>can use a number of techniques to keep payloads small</li><li>use streams to split lots of work into small chunks</li><li>need to do a lot of work? take it off the event loop</li><li>but: users are unpredictable!</li><li>story? templates can easily take 100ms to render</li><li>story? Pinsight at LIFFFT, grabbing 10-50k of JSON and transforming it all took long enough to be noticeable</li></ul></li><li>impact: <strong>high</strong><ul><li>blocks everything else on server - everything!)</li><li>all active requests will take X milliseconds longer, where X milliseconds is how long that synchronous work takes</li></ul></li><li>detection: <strong>medium</strong><ul><li>we've already got response time tracking in place to check for hangs</li><li>not too hard to capture event loop metrics</li></ul></li><li>debuggability: <strong>medium</strong><ul><li>look for requests that take more than a couple milliseconds</li><li>look for synchronous calls and loops</li></ul></li></ul></aside></section><section><h1>Focus: Prevention and Detection</h1><aside class="notes"><ul><li>no magic solution for event loop that's slowing down</li><li>best we can do is try to plan for it, and monitor closely</li></ul></aside></section><section><h1>Demo</h1></section></section><section><img src="img/sheer unstable cliffs.jpg" class="max"></section><section><section><h1>Too much concurrency</h1></section><section><h2>Too much concurrency</h2><div class="center"><table><tr class="fragment"><td>prevention</td><th>medium</th></tr><tr class="fragment"><td>impact</td><th>high</th></tr><tr class="fragment"><td>detection</td><th>medium</th></tr><tr class="fragment"><td>debuggability</td><th>hard</th></tr></table></div><aside class="notes"><ul><li>prevention: <strong>medium</strong><ul><li>specific throttling code</li><li>contracts with remote services</li></ul></li><li>impact: <strong>high</strong><ul><li>can choke event loop, block everything else on server</li><li>do some simple math - 10ms/task, 100 tasks per second</li><li>can take down remote services - good problem to have, I guess</li><li>story: recent contract moving away from Parse, many requests were taking Parse down. socket hang ups!</li></ul></li><li>detection: <strong>medium</strong><ul><li>track concurrency</li><li>event loop metrics</li></ul></li><li>debuggability: <strong>hard</strong><ul><li>may require architecture changes!</li></ul></li></ul></aside></section><section><h1>Focus: Prevention and Detection</h1><aside class="notes"><ul><li>like Blocking the Event Loop, no magic solution</li><li>the best we can do plan well and monitor closely</li><li>especially when working with remote services</li></ul></aside></section><section><h1>Demo</h1></section><section><h2>Many libaries make this easy</h2><ul><li><a href="https://mongodb.github.io/node-mongodb-native/driver-articles/mongoclient.html#connection-pool-configuration">mongodb</a> - connection pool, default size of 5</li><li><a href="https://github.com/brianc/node-postgres/wiki/pg#pgdefaultspoolsize">pg</a> - connection pool, default size of 10</li><li><a href="https://github.com/felixge/node-mysql/#pool-options">mysql</a> - connection pool, default size of 10</li><li><a href="https://github.com/NodeRedis/node_redis/blob/master/examples/backpressure_drain.js">redis</a> - queues up extra commands</li></ul></section></section><section><img src="img/steep and crumbling cliffs.jpg" class="max"></section><section><section><h1>Error from async call</h1></section><section><h2>Error from async call</h2><div class="center"><table><tr class="fragment"><td>prevention</td><th>hard</th></tr><tr class="fragment"><td>impact</td><th>low</th></tr><tr class="fragment"><td>detection</td><th>easy</th></tr><tr class="fragment"><td>debuggability</td><th>medium</th></tr></table></div><aside class="notes"><ul><li>prevention: <strong>hard</strong><ul><li>can't prevent unavailable downstream services!</li></ul></li><li>impact: <strong>low</strong><ul><li>should be no impact, really!</li><li>interrupts some process, maybe just one request</li></ul></li><li>detection: <strong>easy</strong><ul><li>standard error reporting</li><li>if (err) cb(err);</li><li>express error handler, Hapi error handler, top-level callback</li></ul></li><li>debuggability: <strong>hard</strong><ul><li>error message is from low-level library</li><li>what code actually called that async method?</li><li>surprising that this can be hard to debug...</li></ul></li></ul></aside></section><section><h1>Focus: Debuggability</h1><aside class="notes"><ul><li>We can make it easier to see what happened, if we can't prevent it</li></ul></aside></section><section><h1>Demo</h1></section></section><section><img src="img/rocky trail.jpg" class="max"></section><section><section>   <h1>prevention</h1><h1>impact mitigation</h1><h1>detection</h1><h1>debuggability</h1></section></section><section><h1>Better node.js understanding?</h1><aside class="notes"><ul><li>Edge cases help you understand the system!</li></ul></aside></section><section><h1>Go forth and make awesome things!</h1></section><section><h1>Thanks!</h1></section><section><h1>Questions?</h1></section><section><h2>Image sources</h2><ul><li>"huashin trail"</li><li>"beware dangerous cliff"</li><li>"cliff edges are dangerous"</li><li>"dangerous cliffs"</li><li>"sheer unstable cliffs"</li><li>"steep and crumbling cliffs"</li><li>"rocky trail"</li></ul></section><section><section><h1>Resources</h1></section><section><h2>prevention</h2><ul><li>testing: mocha, sinon, chai, supertest, vows, intern, assert, etc.</li><li>code coverage: istanbul, blanket</li><li>static analysis: jshint, eslint, js-complexity, jscs</li><li>thehelp-project gets things in place quick</li></ul></section><section><h2>impact mitigation</h2><ul><li>graceful shutdown: thehelp-cluster</li><li>throttling when busy: toobusy</li><li>TODO: module? concurrency limits</li><li>TODO: module? payload size limits</li></ul></section><section><h2>deployment</h2><ul><li>git push (heroku-style), docker, ansible, capistrano</li><li>graceful shutdown: thehelp-cluster</li></ul></section><section><h2>detection</h2><ul><li>slow event loop: toobusy</li><li>multi-format error capture: thehelp-last-ditch</li><li>stats: graphite</li><li>logging: winston, bunyan, thehelp-log-shim, ELK stack</li></ul></section><section><h2>debuggability</h2><ul><li>promises (like when), thehelp-core/breadcrumbs</li><li>logging: winston, bunyan, thehelp-log-shim, ELK stack</li></ul></section></section></div></div><script src="js/head.min.js"></script><script src="js/reveal.min.js"></script><script>Reveal.initialize({
  controls: false,
  progress: true,
  history: true,
  center: true,
  overview: true,
  
  theme: 'default',
  transition: 'linear',
  
  dependencies: [
    { src: 'js/classList.js', condition: function() { return !document.body.classList; } },
    { src: 'lib/notes/notes.js', async: true },
  ],
  
  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 800,
  height: 600,
  
  // Factor of the display size that should remain empty around the content
  margin: 0.1,
  
  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 3.0
});</script></body></html>